global
    daemon
    maxconn {{ max_connections }}
    log stdout local0 info

defaults
    mode tcp
    timeout connect {{ timeouts.connect }}ms
    timeout client {{ timeouts.client }}ms
    timeout server {{ timeouts.server }}50000ms
    option tcplog
    log global

# Frontend for HTTP traffic (port 80)
frontend http_frontend
    bind *:80
    mode http
    option httplog

    # Route based on HTTP Host header
    {%- for workload in workloads %}
    use_backend workload-http-{{ workload.id }} if { hdr(host) -i {{ workload.domain }} }
    {%- endfor %}

# Frontend for HTTPS traffic (port 443)
frontend https_frontend
    bind *:443
    mode tcp
    option tcplog

    # SNI-based routing rules
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }

    # Route based on SNI
    {%- for workload in workloads %}
    use_backend workload-https-{{ workload.id }} if { req.ssl_sni -i {{ workload.domain }} }
    {%- endfor %}

# Backend servers
{%- for workload in workloads %}
backend workload-http-{{ workload.id }}
    mode tcp
    balance roundrobin
    server cvm {{ workload.http_address }} check
backend workload-https-{{ workload.id }}
    mode tcp
    balance roundrobin
    server cvm {{ workload.https_address }} check
{% endfor %}