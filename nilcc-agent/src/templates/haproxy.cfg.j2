global
    daemon
    maxconn {{ max_connections }}
    log stdout local0 info

defaults
    mode tcp
    timeout connect {{ timeouts.connect }}ms
    timeout client {{ timeouts.client }}ms
    timeout server {{ timeouts.server }}50000ms
    option tcplog
    log global

# Frontend for HTTP traffic (port 80)
frontend http_frontend
    bind *:80
    mode http
    option httplog

    # Route based on HTTP Host header
    {%- for backend in backends %}
    use_backend backend-http-{{ backend.id }} if { hdr(host) -i {{ backend.domain }} }
    {%- endfor %}

# Frontend for HTTPS traffic (port 443)
frontend https_frontend
    bind *:443
    mode tcp
    option tcplog

    # SNI-based routing rules
    tcp-request inspect-delay 5s
    tcp-request content accept if { req_ssl_hello_type 1 }

    # Route based on SNI
    {%- for backend in backends %}
    use_backend backend-https-{{ backend.id }} if { req.ssl_sni -i {{ backend.domain }} }
    {%- endfor %}

# Backend servers
{%- for backend in backends %}
backend backend-http-{{ backend.id }}
    mode tcp
    balance roundrobin
    server cvm {{ backend.http_address }} check
backend backend-https-{{ backend.id }}
    mode tcp
    balance roundrobin
    server cvm {{ backend.https_address }} check
{% endfor %}
