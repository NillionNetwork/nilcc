# nilcc

nilcc allows running workloads securely inside a Trusted Execution Environment (TEE).

# Confidential VMs

Confidential VMs (CVMs) are virtual machines that leverage AMD SEV-SNP to run workloads, in the form of docker compose 
files, in a secure and verifiable way.

All CVMs include a [Caddy](https://caddyserver.com/) instance that will act as a proxy to a specific container in the 
compose setup and will handle TLS certificate generation for it via [Let's encrypt](https://letsencrypt.org/). 

## Integrity

Confidential VMs provide a means to retrieve a hardware generated attestation, that can then be used to ensure that:

* The contents of the filesystem at boot time are the expected ones.
* The virtual machine is running the expected docker compose file.

### dm-verity

The filesystem used to boot the VM is verified using 
[`dm-verity`](https://docs.kernel.org/admin-guide/device-mapper/verity.html), which allows proving that its contents 
haven't been tampered with.

As part of the artifact build process, a VM disk is generated and is ran via `veritysetup` to generate a merkle tree for 
all blocks in its filesystem. The merkle tree itself and the root hash are exported as part of this process and are fed 
into the VM during boot time. The custom initrd image that nilcc uses ensures that the VM disk hasn't been tampered with 
by comparing it against the merkle tree and its root hash.

### Attestation reports

Attestation reports, as generated by AMD SEV-SNP, contain a measurement hash which is derived from a combination of the 
following:

* The kernel being used.
* The initrd image used during boot.
* The Open Virtual Machine Firmware (OVMF) that VM uses.
* The parameters passed to the kernel when launching the VM.
* The number of vCPUs attached to the VM.

In particular, the initrd and kernel parameters can be used together to provide integrity on the workload being ran.

### initrd

The custom initrd image that we use parses the kernel command line to pull out parameters that are needed during the 
boot process. Keep in mind all of these parameters are reflected on the attestation report measurement and therefore can 
be verified by external users.

Our initrd image does the following:

* As mentioned above, it mounts the `dm-verity` disk and ensures its integrity. The root hash for the `dm-verity` disk 
is provided as a kernel parameter, making the integrity of the filesystem verifiable. Note that because `dm-verity` 
mounts the disk as read-only, we need to take some measures to make certain parts of the filesystem mutable as this is 
otherwise too restrictive.
* In order to get around the filesystem immutability restriction, it creates an ext4 filesystem on a disk that is 
attached during boot and encrypts it via LUKS using a random key. This disk is then mounted on `/var`, allowing docker 
compose to download docker images and execute docker containers successfully. Because the disk is encrypted with a 
random key, this prevents the bare metal host from accessing it.
* It makes sure the docker compose that's part of the workload is being ran. This is done by mounting the ISO that 
contains the workload to be ran, sha256-hashing the docker compose file in it, and comparing that with the expected hash 
passed in as a kernel command line parameter.

## Workload ISO file

Workloads are burned into an ISO file that contains all the information and metadata that is specific to a workload. 
This includes:

* The `docker-compose.yaml` file that contains the workload to be ran.
* A `metadata.json` file that contains metadata about the workload being ran such as:
    * The DNS domain for which the Caddy instance will generate a certificate.
    * The container and port that Caddy should proxy to. There should be a single container that acts as the entry point 
    to the workload.
* A `.env` file that contains environment variables that should be passed in to `docker compose` but that for privacy 
reasons shouldn't be part of the docker compose file. Keep in mind the contents of the docker compose file with be 
hashed and included in the attestation report measurement so only non-sensitive information should be stored in it.

## Docker compose execution

After the boot process is completed, the `cvm-agent` program (which is currently a simple bash script) will invoke 
`docker compose up` by passing in two docker compose files:

1. One that contains the Caddy container definition.
2. The docker compose file that defines the workload.

These two files are passed in simultaneously so that all containers are started on the same network and need no tweaks 
to have connectivity between them. This means, for example, that Caddy can direct traffic directly to container `foo` 
without doing any setup to bridge the networks between them.
